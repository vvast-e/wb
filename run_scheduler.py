#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º
- –ü–∞—Ä—Å–µ—Ä –æ—Ç–∑—ã–≤–æ–≤: –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∞—Å–ø–µ–∫—Ç–æ–≤: –∫–∞–∂–¥—ã–µ 32 –º–∏–Ω—É—Ç—ã (—á–µ—Ä–µ–∑ 2 –º–∏–Ω –ø–æ—Å–ª–µ –ø–∞—Ä—Å–µ—Ä–∞)
"""

import asyncio
import logging
import sys
import os
from datetime import datetime
import pytz

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from utils.scheduler import start_scheduler

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
def setup_logging():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
    
    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    os.makedirs('logs', exist_ok=True)
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª
            logging.FileHandler(
                f'logs/scheduler_{datetime.now().strftime("%Y%m%d_%H%M%S")}.log',
                encoding='utf-8'
            ),
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å
            logging.StreamHandler(sys.stdout)
        ]
    )
    
    return logging.getLogger(__name__)

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
    logger = setup_logging()
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
        moscow_tz = pytz.timezone('Europe/Moscow')
        current_time = datetime.now(moscow_tz)
        
        logger.info("üöÄ –ó–ê–ü–£–°–ö –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê –° –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ú –ú–û–ù–ò–¢–û–†–ò–ù–ì–û–ú")
        logger.info("=" * 70)
        logger.info(f"üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {current_time.strftime('%d.%m.%Y %H:%M:%S')} (–ú–°–ö)")
        logger.info(f"üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: {moscow_tz}")
        logger.info("")
        logger.info("üìã –ù–ê–°–¢–†–û–ô–ö–ò –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê:")
        logger.info("   üìù –ü–∞—Ä—Å–µ—Ä –æ—Ç–∑—ã–≤–æ–≤: –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç")
        logger.info("   ü§ñ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∞—Å–ø–µ–∫—Ç–æ–≤: –∫–∞–∂–¥—ã–µ 32 –º–∏–Ω—É—Ç—ã")
        logger.info("   ‚öôÔ∏è  –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á: –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥")
        logger.info("   ‚è∞ –°–ª–µ–¥—É—é—â–∏–π –ø–∞—Ä—Å–∏–Ω–≥: —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç")
        logger.info("   ‚è∞ –°–ª–µ–¥—É—é—â–∏–π –∞–Ω–∞–ª–∏–∑: —á–µ—Ä–µ–∑ 32 –º–∏–Ω—É—Ç—ã")
        logger.info("")
        logger.info("üí° –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã –ø–æ—Å–ª–µ –ø–∞—Ä—Å–µ—Ä–∞")
        logger.info("   —á—Ç–æ–±—ã –ø–∞—Ä—Å–µ—Ä —É—Å–ø–µ–ª –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤—ã")
        logger.info("")
        logger.info("üìä –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–ø–∫—É logs/")
        logger.info("üîÑ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ")
        logger.info("")
        logger.info("‚èπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
        logger.info("=" * 70)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
        start_scheduler()
        
        # –î–µ—Ä–∂–∏–º —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã–º
        try:
            # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
            while True:
                await asyncio.sleep(60)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
                
        except KeyboardInterrupt:
            logger.info("")
            logger.info("‚èπÔ∏è  –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (Ctrl+C)")
            logger.info("üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫...")
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
            from utils.scheduler import scheduler
            scheduler.shutdown()
            
            logger.info("‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            logger.info(f"üìÖ –í—Ä–µ–º—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: {datetime.now(moscow_tz).strftime('%d.%m.%Y %H:%M:%S')} (–ú–°–ö)")
            
    except Exception as e:
        logger.error(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê: {e}")
        import traceback
        logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:\n{traceback.format_exc()}")
        sys.exit(1)

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    asyncio.run(main())



















